<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UMP Pekan AR Navigation</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }
        #ui-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            z-index: 1000;
        }
        select, button {
            margin: 10px;
            padding: 10px;
            font-size: 16px;
            width: 200px;
        }
        #error-message {
            color: red;
            margin-top: 10px;
        }
        #reset-button {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 999;
        }
        .hidden {
            display: none !important;
        }
        #navigation-info {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 14px;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div id="ui-overlay">
        <h1>UMP Pekan AR Navigation</h1>
        <select id="destination-select">
            <option value="">Select Destination</option>
        </select>
        <button id="start-button">Start Navigation</button>
        <div id="error-message"></div>
    </div>

    <button id="reset-button" class="hidden">Reset</button>
    <div id="navigation-info" class="hidden"></div>

    <a-scene
        vr-mode-ui="enabled: false"
        embedded
        arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;"
    >
        <a-camera gps-camera rotation-reader></a-camera>
    </a-scene>

    <script>
        const waypoints = [
            { id: 1, name: 'UMPSA Main Entrance', lat: 3.5424105381833333, lon: 103.42519353920233, color: 'red' },
            { id: 2, name: 'Faculty of Computing', lat: 3.5470578908910624, lon: 103.42766713303656, color: 'green' },
            { id: 3, name: 'Ditec UMPSA', lat: 3.5444022329295355, lon: 103.43162607338732, color: 'blue' },
            { id: 4, name: 'FTKEE Cafe', lat: 3.5395406456778633, lon: 103.4310681740305, color: 'yellow' },
            { id: 5, name: 'PAP', lat: 3.539176561005007, lon: 103.42781733683893, color: 'orange' },
            { id: 6, name: 'Dewan Serbaguna', lat: 3.541152253948052, lon: 103.42994164632783, color: 'purple' },
            { id: 7, name: 'He & She', lat: 3.5389632623719502, lon: 103.42746000826024, color: 'pink' },
            { id: 8, name: 'KK5 Basketball Court', lat: 3.5382039072479077, lon: 103.42795100526111, color: 'cyan' },
            { id: 9, name: 'Library', lat: 3.5427684944699585, lon: 103.43133217957656, color: 'brown' },
            { id: 10, name: 'University Health Centre', lat: 3.5487033301435926, lon: 103.43386164772174, color: 'gray' },
        ];

        const uiOverlay = document.getElementById('ui-overlay');
        const destinationSelect = document.getElementById('destination-select');
        const startButton = document.getElementById('start-button');
        const resetButton = document.getElementById('reset-button');
        const errorMessage = document.getElementById('error-message');
        const navigationInfo = document.getElementById('navigation-info');
        const scene = document.querySelector('a-scene');

        let userLocation = null;
        let selectedDestination = null;
        let watchId = null;

        // Populate destination select
        waypoints.forEach(wp => {
            const option = document.createElement('option');
            option.value = wp.id;
            option.textContent = wp.name;
            destinationSelect.appendChild(option);
        });

        function startNavigation() {
            selectedDestination = waypoints.find(wp => wp.id === parseInt(destinationSelect.value));
            if (selectedDestination && userLocation) {
                uiOverlay.classList.add('hidden');
                resetButton.classList.remove('hidden');
                navigationInfo.classList.remove('hidden');
                updateNavigation();
            } else {
                errorMessage.textContent = 'Please select a destination and ensure your location is available.';
            }
        }

        function resetNavigation() {
            uiOverlay.classList.remove('hidden');
            resetButton.classList.add('hidden');
            navigationInfo.classList.add('hidden');
            selectedDestination = null;
            clearARScene();
        }

        function updateNavigation() {
            if (selectedDestination && userLocation) {
                const distance = calculateDistance(
                    userLocation.lat, userLocation.lon,
                    selectedDestination.lat, selectedDestination.lon
                );
                const bearing = calculateBearing(
                    userLocation.lat, userLocation.lon,
                    selectedDestination.lat, selectedDestination.lon
                );
                const direction = getCardinalDirection(bearing);

                navigationInfo.innerHTML = `
                    <strong>Destination:</strong> ${selectedDestination.name}<br>
                    <strong>Distance:</strong> ${distance.toFixed(0)} meters<br>
                    <strong>Direction:</strong> ${direction}
                `;

                updateARScene();
            }
        }

        function updateARScene() {
            clearARScene();

            const destinationEntity = document.createElement('a-entity');
            destinationEntity.setAttribute('gps-entity-place', `latitude: ${selectedDestination.lat}; longitude: ${selectedDestination.lon};`);
            destinationEntity.setAttribute('geometry', 'primitive: box');
            destinationEntity.setAttribute('material', `color: ${selectedDestination.color}`);
            destinationEntity.setAttribute('scale', '20 20 20');
            destinationEntity.setAttribute('look-at', '[gps-camera]');

            const text = document.createElement('a-text');
            text.setAttribute('value', selectedDestination.name);
            text.setAttribute('look-at', '[gps-camera]');
            text.setAttribute('scale', '50 50 50');
            text.setAttribute('align', 'center');
            text.setAttribute('position', '0 30 0');

            destinationEntity.appendChild(text);
            scene.appendChild(destinationEntity);
        }

        function clearARScene() {
            const entities = scene.querySelectorAll('a-entity');
            entities.forEach(entity => {
                if (entity.getAttribute('gps-entity-place')) {
                    scene.removeChild(entity);
                }
            });
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Earth's radius in meters
            const φ1 = lat1 * Math.PI / 180;
            const φ2 = lat2 * Math.PI / 180;
            const Δφ = (lat2 - lat1) * Math.PI / 180;
            const Δλ = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
                      Math.cos(φ1) * Math.cos(φ2) *
                      Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            return R * c; // Distance in meters
        }

        function calculateBearing(lat1, lon1, lat2, lon2) {
            const φ1 = lat1 * Math.PI / 180;
            const φ2 = lat2 * Math.PI / 180;
            const Δλ = (lon2 - lon1) * Math.PI / 180;

            const y = Math.sin(Δλ) * Math.cos(φ2);
            const x = Math.cos(φ1) * Math.sin(φ2) -
                      Math.sin(φ1) * Math.cos(φ2) * Math.cos(Δλ);
            const θ = Math.atan2(y, x);
            return (θ * 180 / Math.PI + 360) % 360; // Bearing in degrees
        }

        function getCardinalDirection(bearing) {
            const directions = ['N', 'NE', 'E', 'SE', 'S', 'SW', 'W', 'NW'];
            return directions[Math.round(bearing / 45) % 8];
        }

        if ('geolocation' in navigator) {
            watchId = navigator.geolocation.watchPosition(
                (position) => {
                    userLocation = {
                        lat: position.coords.latitude,
                        lon: position.coords.longitude,
                    };
                    if (selectedDestination) {
                        updateNavigation();
                    }
                },
                (error) => {
                    console.error('Geolocation error:', error);
                    errorMessage.textContent = 'Unable to get your location. Please enable GPS and try again.';
                },
                {
                    enableHighAccuracy: true,
                    maximumAge: 0,
                    timeout: 5000
                }
            );
        } else {
            errorMessage.textContent = 'Geolocation is not supported by your browser';
        }

        startButton.addEventListener('click', startNavigation);
        resetButton.addEventListener('click', resetNavigation);

        // Clean up on page unload
        window.addEventListener('beforeunload', () => {
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
            }
        });
    </script>
</body>
</html>

